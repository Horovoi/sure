<%# Renders a breakdown table for income or expense groups %>
<%# Local variables: groups, total, type (:income or :expense), amount_sort_params, current_sort_by, current_sort_direction %>

<%
  color_class = type == :income ? "text-success" : "text-destructive"
  icon_name = type == :income ? "trending-up" : "trending-down"
  title_key = type == :income ? "reports.transactions_breakdown.table.income" : "reports.transactions_breakdown.table.expense"
%>

<div>
  <div class="text-large mb-4 flex items-center gap-2 text-lg">
    <%= icon(icon_name, class: "w-5 h-5") %>
    <span><%= t(title_key) %>:</span>
    <span class="font-medium text-secondary <%= color_class %>"> <%= Money.new(total, Current.family.currency).format %></span>
  </div>

  <%# Treemap chart â€” expenses only %>
  <% if type == :expense && groups.any? && total > 0 %>
    <%
      days_in_period = defined?(start_date) && defined?(end_date) && start_date && end_date ? (end_date - start_date).to_i + 1 : 30
      currency = Current.family.currency

      treemap_categories = groups.each_with_index.map { |g, idx|
        pct = (g[:total] / total.to_f * 100)
        subs = (g[:subcategories] || []).first(3).map { |s|
          sub_pct = g[:total] > 0 ? (s[:total] / g[:total].to_f * 100).round(1) : 0
          {
            name: s[:category_name],
            color: s[:category_color] || g[:category_color] || "#94a3b8",
            amount: Money.new(s[:total], currency).format,
            percentage: sub_pct
          }
        }
        {
          name: g[:category_name],
          color: g[:category_color] || "#94a3b8",
          percentage: pct.round(1),
          amount: g[:total],
          formattedAmount: Money.new(g[:total], currency).format,
          count: g[:count],
          avgFormatted: g[:count] > 1 ? Money.new(g[:total] / g[:count], currency).format : nil,
          dailyAvgFormatted: days_in_period > 0 ? Money.new(g[:total] / days_in_period, currency).format : nil,
          rank: idx + 1,
          subcategories: subs,
          totalSubcategories: (g[:subcategories] || []).size
        }
      }.to_json
    %>
    <div class="mb-6 relative"
         data-controller="reports-treemap"
         data-reports-treemap-categories-value="<%= treemap_categories %>"
         data-reports-treemap-type-value="<%= type %>">
    </div>
  <% end %>

  <% if type == :income %>
    <div class="bg-container-inset rounded-xl p-1 overflow-x-auto">
      <div class="w-max sm:w-full">
        <div class="grid grid-cols-4 items-center uppercase text-xs font-medium text-secondary px-4 py-2">
          <div class="col-span-2 font-medium text-secondary"><%= t("reports.transactions_breakdown.table.category") %></div>
          <div class="col-span-1 text-right font-medium text-secondary">
            <%= link_to reports_path(amount_sort_params), class: "inline-flex items-center gap-1 hover:text-primary" do %>
              <%= t("reports.transactions_breakdown.table.amount") %>
              <% if current_sort_by == "amount" %>
                <%= icon(current_sort_direction == "desc" ? "chevron-down" : "chevron-up", class: "w-3 h-3") %>
              <% end %>
            <% end %>
          </div>
          <div class="col-span-1 text-right font-medium text-secondary"><%= t("reports.transactions_breakdown.table.percentage") %></div>
        </div>

        <div class="bg-container rounded-lg shadow-border-xs">
          <% groups.each_with_index do |group, idx| %>
            <%= render "reports/category_row", item: group, total: total, color_class: color_class, level: :category %>
            <% if idx < groups.size - 1 %>
              <%= render "shared/ruler", classes: "mx-3 lg:mx-4" %>
            <% end %>
            <% if group[:subcategories].present? && group[:subcategories].any? %>
              <% group[:subcategories].each_with_index do |subcategory, sub_idx| %>
                <%= render "reports/category_row", item: subcategory, total: total, color_class: color_class, level: :subcategory %>
              <% end %>
              <% if idx < groups.size - 1 %>
                <%= render "shared/ruler", classes: "mx-3 lg:mx-4" %>
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <details class="group">
      <summary class="cursor-pointer text-sm text-secondary hover:text-primary mb-3 flex items-center gap-1">
        <%= icon "chevron-right", class: "w-4 h-4 group-open:rotate-90 transition-transform" %>
        <%= t("reports.transactions_breakdown.table.view_category_details", count: groups.size) %>
      </summary>

      <div class="bg-container-inset rounded-xl p-1 overflow-x-auto">
        <div class="w-max sm:w-full">
          <div class="grid grid-cols-4 items-center uppercase text-xs font-medium text-secondary px-4 py-2">
            <div class="col-span-2 font-medium text-secondary"><%= t("reports.transactions_breakdown.table.category") %></div>
            <div class="col-span-1 text-right font-medium text-secondary">
              <%= link_to reports_path(amount_sort_params), class: "inline-flex items-center gap-1 hover:text-primary" do %>
                <%= t("reports.transactions_breakdown.table.amount") %>
                <% if current_sort_by == "amount" %>
                  <%= icon(current_sort_direction == "desc" ? "chevron-down" : "chevron-up", class: "w-3 h-3") %>
                <% end %>
              <% end %>
            </div>
            <div class="col-span-1 text-right font-medium text-secondary"><%= t("reports.transactions_breakdown.table.percentage") %></div>
          </div>

          <div class="bg-container rounded-lg shadow-border-xs">
            <% groups.each_with_index do |group, idx| %>
              <%= render "reports/category_row", item: group, total: total, color_class: color_class, level: :category %>
              <% if idx < groups.size - 1 %>
                <%= render "shared/ruler", classes: "mx-3 lg:mx-4" %>
              <% end %>
              <% if group[:subcategories].present? && group[:subcategories].any? %>
                <% group[:subcategories].each_with_index do |subcategory, sub_idx| %>
                  <%= render "reports/category_row", item: subcategory, total: total, color_class: color_class, level: :subcategory %>
                <% end %>
                <% if idx < groups.size - 1 %>
                  <%= render "shared/ruler", classes: "mx-3 lg:mx-4" %>
                <% end %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </details>
  <% end %>
</div>
