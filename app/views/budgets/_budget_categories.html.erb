<%# locals: (budget:) %>

<div>
  <div class="flex items-center gap-1.5 px-3 md:px-4 py-2 text-xs font-medium text-secondary uppercase">
    <p>Categories</p>
    <span class="text-subdued">&middot;</span>
    <p><%= budget.budget_categories.count %></p>

    <p class="ml-auto">Amount</p>
  </div>

  <div class="bg-container py-1 shadow-border-xs rounded-md">
    <% if budget.family.categories.expenses.empty? %>
      <div class="py-8">
        <%= render "budget_categories/no_categories" %>
      </div>
    <% else %>
      <% category_groups = BudgetCategory::Group.for(budget.budget_categories) %>

      <% category_groups.each_with_index do |group, index| %>
        <div class="py-2">
          <%= render "budget_categories/budget_category", budget_category: group.budget_category %>

          <div>
            <% group.budget_subcategories.each do |budget_subcategory| %>
              <div class="w-full flex items-start">
                <div class="ml-8 pt-4 flex items-center justify-center text-subdued">
                  <%= icon "corner-down-right" %>
                </div>

                <%= render "budget_categories/budget_category", budget_category: budget_subcategory %>
              </div>
            <% end %>

            <% if group.budget_subcategories.any? && group.other_spending > 0 %>
              <div class="w-full flex items-start">
                <div class="ml-8 pt-4 flex items-center justify-center text-subdued">
                  <%= icon "corner-down-right" %>
                </div>

                <div class="flex-1 min-w-0 block px-4 py-2">
                  <div class="flex items-center gap-3">
                    <div class="h-8 w-8 flex-shrink-0 rounded-full flex justify-center items-center"
                          style="
                            background-color: color-mix(in oklab, <%= group.color %> 10%, transparent);
                            color: <%= group.color %>;">
                      <% if group.category.lucide_icon %>
                        <%= icon(group.category.lucide_icon, color: "current", size: "sm") %>
                      <% else %>
                        <%= render DS::FilledIcon.new(
                          variant: :text,
                          hex_color: group.color,
                          text: group.name,
                          size: "sm",
                          rounded: true
                        ) %>
                      <% end %>
                    </div>

                    <p class="flex-1 min-w-0 text-sm font-medium text-primary truncate">
                      <%= t("budgets.budget_categories.other_category", category: group.name) %>
                    </p>

                    <p class="ml-auto text-sm font-medium text-primary whitespace-nowrap">
                      <%= format_money(Money.new(group.other_spending, budget.family.currency)) %>
                    </p>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <%= render "shared/ruler" %>
      <% end %>
      <div class="py-2">
        <%= render "budget_categories/budget_category", budget_category: budget.uncategorized_budget_category %>
      </div>
    <% end %>
  </div>
</div>
