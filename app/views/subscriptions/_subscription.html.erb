<tr id="<%= dom_id(subscription) %>"
    class="border-b border-subdued hover:bg-surface-hover">
  <td class="py-3 px-4 <%= "opacity-60" unless subscription.active? %>">
    <div class="flex items-center gap-3">
      <%# Logo with fallback for broken images %>
      <div class="relative w-8 h-8 flex-shrink-0">
        <% if subscription.subscription_logo_url.present? %>
          <%= image_tag subscription.subscription_logo_url,
              class: "w-8 h-8 rounded-full object-cover",
              loading: "lazy",
              onerror: "this.style.display='none'; this.nextElementSibling.style.display='flex';" %>
          <div style="display: none;">
            <%= render DS::FilledIcon.new(
              variant: :text,
              text: subscription.display_name,
              size: "md",
              rounded: true
            ) %>
          </div>
        <% else %>
          <%= render DS::FilledIcon.new(
            variant: :text,
            text: subscription.display_name,
            size: "md",
            rounded: true
          ) %>
        <% end %>
      </div>

      <%# Name and merchant %>
      <div>
        <span class="text-sm text-primary font-medium block"><%= subscription.display_name %></span>
        <% if subscription.category.present? %>
          <span class="text-xs text-secondary"><%= subscription.category.name %></span>
        <% end %>
      </div>
    </div>
  </td>

  <td class="py-3 px-4 <%= "opacity-60" unless subscription.active? %>">
    <span class="text-sm font-medium text-primary">
      <%= format_money(-subscription.amount_money) %>
    </span>
    <% if subscription.currency != Current.family.currency %>
      <span class="text-xs text-secondary block">
<%= format_money(subscription.amount_money.exchange_to(Current.family.currency, fallback_rate: 1).abs * -1) %>
      </span>
    <% elsif subscription.billing_cycle_yearly? %>
      <span class="text-xs text-secondary block">
        ~<%= format_money(Money.new(subscription.monthly_cost, subscription.currency)) %>/mo
      </span>
    <% end %>
  </td>

  <td class="py-3 px-4 <%= "opacity-60" unless subscription.active? %>">
    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= subscription.billing_cycle_monthly? ? "bg-violet-100 text-violet-700" : "bg-yellow-100 text-yellow-700" %>">
      <%= t("subscriptions.billing_cycle.#{subscription.billing_cycle}") %>
    </span>
  </td>

  <td class="py-3 px-4 text-sm <%= "opacity-60" unless subscription.active? %>">
    <% if subscription.overdue? %>
      <span class="text-destructive font-medium"><%= l(subscription.next_expected_date, format: :short) %></span>
      <span class="inline-flex items-center ml-1 px-1.5 py-0.5 rounded text-xs font-medium bg-red-50 text-destructive">
        <%= t("subscriptions.index.table.overdue") %>
      </span>
    <% elsif subscription.due_today? %>
      <span class="text-primary font-medium"><%= l(subscription.next_expected_date, format: :short) %></span>
      <span class="inline-flex items-center ml-1 px-1.5 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700">
        <%= t("subscriptions.index.table.due_today") %>
      </span>
    <% else %>
      <span class="text-secondary"><%= l(subscription.next_expected_date, format: :short) %></span>
    <% end %>
  </td>

  <td class="py-3 px-4 <%= "opacity-60" unless subscription.active? %>">
    <% if subscription.active? %>
      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-50 text-success">
        <%= t("subscriptions.status.active") %>
      </span>
    <% else %>
      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-surface-inset text-secondary">
        <%= t("subscriptions.status.inactive") %>
      </span>
    <% end %>
  </td>

  <td class="py-3 px-4 text-right">
    <div class="flex items-center justify-end gap-2">
      <% if subscription.actionable? %>
        <% if subscription.default_account.present? %>
          <%= button_to record_transaction_subscription_path(subscription),
              method: :post,
              title: t(".record_now"),
              class: "p-1.5 rounded hover:bg-green-50 text-success" do %>
            <%= icon "check-circle", size: "sm", color: "current" %>
          <% end %>
        <% else %>
          <%= link_to edit_subscription_path(subscription),
              title: t(".link_account_to_record"),
              data: { turbo_frame: "_top" },
              class: "p-1.5 rounded hover:bg-yellow-50 text-warning" do %>
            <%= icon "link", size: "sm", color: "current" %>
          <% end %>
        <% end %>
      <% else %>
        <span class="w-7 h-7"></span>
      <% end %>

      <%= render DS::Menu.new do |menu| %>
        <% if subscription.actionable? %>
          <% menu.with_item(variant: "button", text: t(".skip"), icon: "fast-forward",
              href: skip_occurrence_subscription_path(subscription), method: :post) %>
          <% menu.with_item(variant: "divider") %>
        <% end %>
        <% menu.with_item(variant: "link", text: t(".edit"), icon: "pencil",
            href: edit_subscription_path(subscription), data: { turbo_frame: "_top" }) %>
        <% menu.with_item(variant: "button", text: subscription.active? ? t(".pause") : t(".resume"),
            icon: subscription.active? ? "pause" : "play",
            href: toggle_status_subscription_path(subscription), method: :post) %>
        <% menu.with_item(variant: "button", text: t(".delete"), icon: "trash-2",
            href: subscription_path(subscription), method: :delete,
            confirm: CustomConfirm.for_resource_deletion("subscription")) %>
      <% end %>
    </div>
  </td>
</tr>
