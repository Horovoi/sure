<div class="space-y-4 flex flex-col" data-controller="subscription-calendar">
  <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <div>
      <h1 class="text-primary text-xl font-medium"><%= t(".title") %></h1>
      <p class="text-secondary text-sm mt-1">
        <span class="font-medium text-primary"><%= @subscriptions.count %></span> active ·
        <span class="font-medium text-primary"><%= format_money(@monthly_total) %></span>/mo ·
        <span class="font-medium text-primary"><%= format_money(@monthly_total * 12) %></span>/yr
      </p>
    </div>

    <div class="flex items-center gap-2">
      <%= render DS::Link.new(
        text: t(".list"),
        icon: "list",
        variant: "outline",
        href: subscriptions_path
      ) %>

      <%= render DS::Link.new(
        text: t("subscriptions.index.new_subscription"),
        variant: "primary",
        icon: "plus",
        href: new_subscription_path(return_to: "calendar")
      ) %>
    </div>
  </header>

  <%# Calendar navigation %>
  <div class="bg-container rounded-xl shadow-border-xs p-4">
    <div class="flex items-center justify-between mb-4">
      <%= link_to calendar_subscriptions_path(month: @month.prev_month.strftime("%Y-%m-%d")),
          class: "p-2 rounded-lg hover:bg-surface-inset transition-colors" do %>
        <%= icon "chevron-left", size: "sm" %>
      <% end %>

      <div class="flex items-center gap-3">
        <h2 class="text-lg font-medium text-primary">
          <%= @month.strftime("%B %Y") %>
        </h2>
        <% unless @month.beginning_of_month == Date.current.beginning_of_month %>
          <%= render DS::Link.new(
            text: t(".today"),
            variant: "outline",
            size: :sm,
            href: calendar_subscriptions_path
          ) %>
        <% end %>
      </div>

      <%= link_to calendar_subscriptions_path(month: @month.next_month.strftime("%Y-%m-%d")),
          class: "p-2 rounded-lg hover:bg-surface-inset transition-colors" do %>
        <%= icon "chevron-right", size: "sm" %>
      <% end %>
    </div>

    <%# Quick stats bar - pill style %>
    <div class="flex items-center gap-3 mb-4">
      <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-surface-inset">
        <span class="text-xs text-secondary">This week</span>
        <span class="text-xs font-medium text-primary"><%= @this_week_data.size %></span>
        <span class="text-xs text-tertiary">·</span>
        <span class="text-xs font-medium text-primary"><%= format_money(@this_week_total) %></span>
      </div>
      <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg <%= @today_subscriptions.any? ? 'bg-green-500/10' : 'bg-surface-inset' %>">
        <span class="text-xs text-secondary">Due today</span>
        <span class="text-xs font-medium <%= @today_subscriptions.any? ? 'text-green-600' : 'text-primary' %>">
          <%= @today_subscriptions.size %>
        </span>
      </div>
    </div>

    <%# Calendar grid %>
    <div class="rounded-lg overflow-hidden border border-secondary">
      <%# Day headers %>
      <div class="grid grid-cols-7 bg-surface-inset">
        <% %w[Mon Tue Wed Thu Fri Sat Sun].each do |day| %>
          <div class="py-2 text-center text-xs font-medium text-secondary uppercase">
            <%= day %>
          </div>
        <% end %>
      </div>

      <%# Calendar days %>
      <div class="grid grid-cols-7">
        <%# Padding for start of month %>
        <% start_day = (@month.beginning_of_month.wday - 1) % 7 %>
        <% start_day.times do %>
          <div class="aspect-[5/4] p-1.5 border-t border-r border-secondary bg-surface-inset"></div>
        <% end %>

        <%# Days of the month %>
        <% (@month.beginning_of_month..@month.end_of_month).each do |date| %>
          <% subscriptions_on_day = @calendar_data[date] || [] %>
          <% is_today = date == Date.current %>
          <% has_monthly = subscriptions_on_day.any?(&:billing_cycle_monthly?) %>
          <% has_yearly = subscriptions_on_day.any?(&:billing_cycle_yearly?) %>

          <div class="aspect-[5/4] p-1.5 border-t border-r border-secondary hover:bg-surface-hover transition-colors flex flex-col <%= 'ring-2 ring-green-600 ring-inset rounded-sm' if is_today %>"
               data-action="click->subscription-calendar#showDayDetails mouseenter->subscription-calendar#handleCellMouseEnter mouseleave->subscription-calendar#handleCellMouseLeave touchstart->subscription-calendar#handleCellTouchStart touchend->subscription-calendar#handleCellTouchEnd touchmove->subscription-calendar#handleCellTouchMove"
               data-date="<%= date.iso8601 %>">
            <%# Header: Day number + billing cycle dots %>
            <div class="flex items-start justify-between">
              <span class="text-sm font-medium <%= is_today ? 'text-green-600' : 'text-primary' %>">
                <%= date.day %>
              </span>

              <% if subscriptions_on_day.any? %>
                <div class="flex items-center gap-0.5">
                  <% if has_monthly %>
                    <div class="w-2 h-2 rounded-full bg-violet-500"></div>
                  <% end %>
                  <% if has_yearly %>
                    <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                  <% end %>
                </div>
              <% end %>
            </div>

            <%# Overlapping icon stack %>
            <% if subscriptions_on_day.any? %>
              <div class="flex items-center justify-center flex-1 -space-x-2">
                <% subscriptions_on_day.first(3).each do |sub| %>
                  <%= link_to edit_subscription_path(sub, return_to: "calendar"),
                      class: "block" do %>
                    <% if sub.subscription_logo_url.present? %>
                      <div class="relative">
                        <%= image_tag sub.subscription_logo_url,
                            class: "w-7 h-7 rounded-full object-cover ring-2 ring-container",
                            loading: "lazy",
                            onerror: "this.style.display='none'; this.nextElementSibling.style.display='flex';" %>
                        <div class="w-7 h-7 rounded-full items-center justify-center text-[10px] font-bold text-white bg-gray-400 ring-2 ring-container" style="display: none;">
                          <%= sub.display_name[0].upcase %>
                        </div>
                      </div>
                    <% else %>
                      <div class="w-7 h-7 rounded-full flex items-center justify-center text-[10px] font-bold text-white bg-gray-400 ring-2 ring-container">
                        <%= sub.display_name[0].upcase %>
                      </div>
                    <% end %>
                  <% end %>
                <% end %>

                <% if subscriptions_on_day.size > 3 %>
                  <div class="w-7 h-7 rounded-full bg-surface-inset ring-2 ring-container flex items-center justify-center text-[10px] font-medium text-secondary">
                    +<%= subscriptions_on_day.size - 3 %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>

        <%# Padding for end of month %>
        <% end_day = (7 - @month.end_of_month.wday) % 7 %>
        <% end_day.times do %>
          <div class="aspect-[5/4] p-1.5 border-t border-r border-secondary bg-surface-inset"></div>
        <% end %>
      </div>
    </div>

    <%# Legend %>
    <div class="flex items-center gap-4 mt-4 text-xs text-secondary">
      <div class="flex items-center gap-1.5">
        <div class="w-2 h-2 rounded-full bg-violet-500"></div>
        <span><%= t(".legend.monthly") %></span>
      </div>
      <div class="flex items-center gap-1.5">
        <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
        <span><%= t(".legend.yearly") %></span>
      </div>
    </div>
  </div>

  <%# Hover card (populated via Stimulus) %>
  <div class="hidden fixed z-50 bg-container shadow-border-xs rounded-xl p-3 min-w-[220px] max-w-[300px] pointer-events-none"
       data-subscription-calendar-target="hoverCard">
  </div>

  <%# Day details modal/drawer (populated via Stimulus) %>
  <div id="day-details-drawer"
       class="hidden fixed inset-0 z-50"
       data-subscription-calendar-target="drawer">
    <div class="absolute inset-0 bg-black/50" data-action="click->subscription-calendar#closeDayDetails"></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-container shadow-xl overflow-y-auto">
      <div class="p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-primary" data-subscription-calendar-target="drawerTitle">
            Subscriptions
          </h3>
          <button type="button"
                  class="p-2 rounded-lg hover:bg-surface-inset transition-colors"
                  data-action="click->subscription-calendar#closeDayDetails">
            <%= icon "x", size: "sm" %>
          </button>
        </div>
        <div data-subscription-calendar-target="drawerContent">
          <%# Content populated by JavaScript %>
        </div>
      </div>
    </div>
  </div>

  <%# Pass calendar data to JavaScript %>
  <script type="application/json" data-subscription-calendar-target="calendarData">
    <%= raw({
      family_currency: Current.family.currency,
      dates: @calendar_data.transform_keys(&:iso8601).transform_values { |subs|
        subs.map do |sub|
          is_foreign = sub.currency != Current.family.currency
          {
            id: sub.id,
            name: sub.display_name,
            amount: format_money(-sub.amount_money),
            converted_amount: is_foreign ? format_money(sub.amount_money.exchange_to(Current.family.currency, fallback_rate: 1).abs * -1) : nil,
            converted_amount_raw: is_foreign ? sub.amount_money.exchange_to(Current.family.currency, fallback_rate: 1).abs.amount : sub.amount_money.abs.amount,
            is_foreign_currency: is_foreign,
            billing_cycle: sub.billing_cycle,
            logo_url: sub.subscription_logo_url,
            edit_url: edit_subscription_path(sub, return_to: "calendar"),
            service_category: sub.subscription_service&.category,
            account_name: sub.default_account&.name
          }
        end
      }
    }.to_json) %>
  </script>
</div>
